import{r as d,j as e,C as F,R as U,m as N}from"./index-Bi-v-Kal.js";import{a as P,F as T,D as O,E as I}from"./index-D_Bixaei.js";import{C as Y,a as $}from"./CCardBody-CXRMg5zC.js";import{C as M}from"./CCardHeader-DbgGSS-j.js";import{C as g}from"./CFormSelect-D8WnZ7AH.js";import{C as z}from"./CAlert-B2LPwVDN.js";import{C as W,a as G,b as i,c as n,d as q,e as l,f as J}from"./CTable-_A7mZ4wq.js";import"./CFormControlWrapper-C4S1W_Ya.js";const re=()=>{const[h,y]=d.useState([]),[u,_]=d.useState("all"),[x,L]=d.useState(new Date().getFullYear()),[p,E]=d.useState(new Date().getMonth()+1),[c,b]=d.useState(!1),[f,m]=d.useState(null),[C,S]=d.useState(!1),A=Array.from({length:new Date().getFullYear()-2020+1},(t,a)=>2020+a),w=async()=>{var t,a;try{b(!0),m(null);const s=await N.get("/payrolls",{params:{year:x,month:p}});let r=s.data.payroll||s.data;if(Array.isArray(r))u!=="all"&&(r=r.filter(j=>{const D=new Date(j.start_date).getDate();return u==="first"?D<=15:D>15})),y(r);else throw new Error("Invalid payroll data format received from server")}catch(s){console.error("Error fetching payroll data:",s),m(((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||s.message||"Failed to fetch payroll data"),y([])}finally{b(!1)}};d.useEffect(()=>{w()},[x,p,u]);const R=()=>h.reduce((t,a)=>t+parseFloat(a.net_salary||0),0),o=t=>parseFloat(t||0).toLocaleString("en-US",{style:"currency",currency:"PHP",minimumFractionDigits:2}),v=t=>t.reduce((a,s)=>{const r=s.department||"Unassigned";return a[r]||(a[r]=[]),a[r].push(s),a},{}),k=async()=>{try{S(!0);const t=await N.get("/payroll/download-report",{params:{year:x,month:p},responseType:"blob",withCredentials:!0}),a=window.URL.createObjectURL(new Blob([t.data])),s=document.createElement("a");s.href=a,s.setAttribute("download",`payroll-report-${x}-${p}.pdf`),document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(a)}catch(t){console.error("Error downloading PDF:",t),m("Failed to download the PDF. Please try again.")}finally{S(!1)}},B={backgroundColor:"#f8f9fa",fontWeight:"bold",fontSize:"1.1em",padding:"10px"},H={backgroundColor:"#e9ecef",fontWeight:"bold"};return e.jsx("div",{children:e.jsxs(Y,{className:"mb-4",children:[e.jsxs(M,{className:"d-flex justify-content-between align-items-center flex-wrap",children:[e.jsx("strong",{children:"Payroll Report"}),e.jsxs("div",{className:"d-flex flex-wrap gap-2 align-items-center",children:[e.jsxs(g,{value:u,onChange:t=>_(t.target.value),style:{width:"150px"},disabled:c,children:[e.jsx("option",{value:"all",children:"All Periods"}),e.jsx("option",{value:"first",children:"First Half"}),e.jsx("option",{value:"second",children:"2nd Half"})]}),e.jsx(g,{value:p,onChange:t=>E(parseInt(t.target.value)),style:{width:"120px"},disabled:c,children:Array.from({length:12},(t,a)=>e.jsx("option",{value:a+1,children:new Date(2023,a).toLocaleString("default",{month:"long"})},a+1))}),e.jsx(g,{value:x,onChange:t=>L(parseInt(t.target.value)),style:{width:"90px"},disabled:c,children:A.map(t=>e.jsx("option",{value:t,children:t},t))}),e.jsx(P,{color:"secondary",onClick:w,disabled:c,children:e.jsx(T,{icon:O,spin:c})}),e.jsx(P,{color:"primary",onClick:k,disabled:C||c||h.length===0,children:C?e.jsx(F,{size:"sm"}):e.jsx(T,{icon:I})})]})]}),e.jsxs($,{children:[f&&e.jsx(z,{color:"danger",dismissible:!0,onClose:()=>m(null),children:f}),c?e.jsxs("div",{className:"text-center py-4",children:[e.jsx(F,{}),e.jsx("p",{children:"Loading payroll data..."})]}):e.jsx("div",{className:"table-responsive",children:e.jsxs(W,{hover:!0,bordered:!0,responsive:!0,children:[e.jsx(G,{children:e.jsxs(i,{children:[e.jsx(n,{children:"Employee Name"}),e.jsx(n,{children:"Department"}),e.jsx(n,{children:"Base Salary"}),e.jsx(n,{children:"Overtime"}),e.jsx(n,{children:"Bonus"}),e.jsx(n,{children:"Benefits"}),e.jsx(n,{children:"Deductions"}),e.jsx(n,{children:"Net Salary"})]})}),e.jsx(q,{children:h.length>0?Object.entries(v(h)).map(([t,a],s)=>e.jsxs(U.Fragment,{children:[e.jsx(i,{children:e.jsxs(l,{colSpan:"8",style:B,children:[t," -"," ",new Date(a[0].start_date).toLocaleDateString()," to"," ",new Date(a[0].end_date).toLocaleDateString()]})}),a.map((r,j)=>e.jsxs(i,{children:[e.jsx(l,{children:r.name||"N/A"}),e.jsx(l,{children:r.department||"N/A"}),e.jsx(l,{children:o(r.base_salary)}),e.jsx(l,{children:o(r.total_overtime_amount)}),e.jsx(l,{children:o(r.bonus)}),e.jsx(l,{children:o(r.benefits_total)}),e.jsx(l,{children:o(r.total_deductions||r.tax)}),e.jsx(l,{children:o(r.net_salary)})]},`${r.id}-${j}`)),e.jsxs(i,{style:H,children:[e.jsx(l,{colSpan:"6",className:"text-center",children:e.jsx("strong",{children:"Department Total"})}),e.jsx(l,{colSpan:"2",className:"text-center",children:e.jsx("strong",{children:o(a.reduce((r,j)=>r+parseFloat(j.net_salary||0),0))})})]}),e.jsx("br",{}),s<Object.keys(v(h)).length-1&&e.jsx(i,{children:e.jsx(l,{colSpan:"8",style:{padding:"10px"},children:e.jsx("hr",{style:{borderTop:" #ddd"}})})})]},t)):e.jsx(i,{children:e.jsx(l,{colSpan:"8",className:"text-center py-4",children:f?"Error loading data":"No payroll data available for selected period"})})}),h.length>0&&e.jsx(J,{children:e.jsxs(i,{style:{backgroundColor:"#dee2e6"},children:[e.jsx(n,{colSpan:"6",className:"text-center",children:e.jsx("strong",{children:"Grand Total"})}),e.jsx(n,{colSpan:"2",className:"text-center",children:e.jsx("strong",{children:o(R())})})]})})]})})]})]})})};export{re as default};
