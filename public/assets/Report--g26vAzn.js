import{r as l,j as e,C as _,R as Q}from"./index-DLmnIqy-.js";import{F,x as V,A as X,a as Z,B as ee}from"./index-BzeTyS9E.js";import{a as $}from"./api-DwbPoVFv.js";import{C as te,a as ae}from"./CCardBody-DfS5_nuD.js";import{C as re}from"./CCardHeader-BhAXpAMg.js";import{C as se}from"./CInputGroup-a2s_gtI6.js";import{C as ne}from"./CInputGroupText-BZrPrPs0.js";import{C as le}from"./CFormInput-Dw_omB7Q.js";import{b as oe,c as de,d as ce,a as ie}from"./DefaultLayout-da0zcv8b.js";import{C as b}from"./CFormControlWrapper-BnNbabf9.js";import{C as w}from"./CFormSelect-CKgELBJY.js";import{C as he}from"./CAlert-BZjV-HHH.js";import{C as xe,a as me,b as u,c as o,d as pe,e as n,f as ue}from"./CTable-DPZp-y3R.js";import"./index-xsH4HHeE.js";const $e=()=>{const[v,P]=l.useState([]),[m,S]=l.useState([]),[i,R]=l.useState("all"),[j,B]=l.useState(new Date().getFullYear()),[f,E]=l.useState(new Date().getMonth()+1),[g,N]=l.useState(!1),[y,C]=l.useState(null),[L,A]=l.useState(!1),[p,H]=l.useState(""),[h,k]=l.useState("all"),[D,je]=l.useState("all"),[M,I]=l.useState([]),[fe,ge]=l.useState(!1),U=Array.from({length:new Date().getFullYear()-2020+1},(t,r)=>2020+r),Y=async()=>{var t,r;try{N(!0),C(null);const s=await $.get("/payrolls/filter",{params:{year:j,month:f,period:i!=="all"?i:void 0,department:h!=="all"?h:void 0,status:D!=="all"?D:void 0,search:p||void 0}});let a=s==null?void 0:s.data;if(a!=null&&a.data&&Array.isArray(a.data))a=a.data;else if(!Array.isArray(a))throw console.error("Unexpected response format:",s.data),new Error("Invalid payroll data format received from server");P(a),S(a);const d=[...new Set(a.map(c=>c.department))];I(d)}catch(s){console.error("Error fetching payroll data:",s),C(((r=(t=s.response)==null?void 0:t.data)==null?void 0:r.message)||s.message||"Failed to fetch payroll data"),P([]),S([])}finally{N(!1)}};l.useEffect(()=>{Y()},[j,f,i,h,D,p]),l.useEffect(()=>{if(p){const t=v.filter(r=>r.name.toLowerCase().includes(p.toLowerCase())||r.employee_id.toLowerCase().includes(p.toLowerCase()));S(t)}else S(v)},[p,v]);const O=()=>m.reduce((t,r)=>t+parseFloat(r.net_salary||0),0),x=t=>parseFloat(t||0).toLocaleString("en-US",{style:"currency",currency:"PHP",minimumFractionDigits:2}),T=t=>t.reduce((r,s)=>{const a=s.department||"Unassigned";return r[a]||(r[a]=[]),r[a].push(s),r},{}),G=async()=>{var t,r;try{A(!0),C(null);const s={year:j,month:f};i!=="all"&&(s.period=i),h!=="all"&&(s.department=h);const a=await $.get("/payroll/download-report",{params:s,responseType:"blob"}),d=window.URL.createObjectURL(new Blob([a.data])),c=document.createElement("a");c.href=d,c.setAttribute("download",`payroll-report-${j}-${f}${h!=="all"?`-${h}`:""}.pdf`),document.body.appendChild(c),c.click(),c.remove(),window.URL.revokeObjectURL(d)}catch(s){console.error("PDF download error:",s),C(((r=(t=s.response)==null?void 0:t.data)==null?void 0:r.message)||"Failed to generate PDF report")}finally{A(!1)}},z=(t,r)=>{const s=new Date(t),a=new Date(r);return`${s.getDate()} ${s.toLocaleString("default",{month:"short"})} - 
            ${a.getDate()} ${a.toLocaleString("default",{month:"short"})}`},W=t=>{switch(t==null?void 0:t.toLowerCase()){case"paid":return"success";case"pending":return"warning";default:return"secondary"}},q={backgroundColor:"#f8f9fa",fontWeight:"bold",fontSize:"1.1em",padding:"10px"},J={backgroundColor:"#e9ecef",fontWeight:"bold"},K=t=>{if(!t.length)return"N/A";const r=t.map(c=>new Date(c.start_date)),s=t.map(c=>new Date(c.end_date)),a=new Date(Math.min(...r)),d=new Date(Math.max(...s));return`${a.getDate()} ${a.toLocaleString("default",{month:"short"})} - ${d.getDate()} ${d.toLocaleString("default",{month:"short"})}`};return e.jsx("div",{children:e.jsxs(te,{className:"mb-4",children:[e.jsxs(re,{className:"d-flex justify-content-between align-items-center flex-wrap",children:[e.jsx("strong",{children:"Payroll Report"}),e.jsx("div",{className:"mb-3",children:e.jsxs("strong",{children:["Period:"," ",i==="all"?`All Periods (${K(m)})`:i==="first"?"First Half":"Second Half"," ","| Month:"," ",new Date(2023,f-1).toLocaleString("default",{month:"long"})," | Year: ",j]})}),e.jsxs("div",{className:"d-flex flex-wrap gap-2 align-items-center",children:[e.jsxs(se,{children:[e.jsx(ne,{children:e.jsx(F,{icon:V})}),e.jsx(le,{placeholder:"Search employee...",value:p,onChange:t=>H(t.target.value)})]}),e.jsxs(oe,{autoClose:"outside",children:[e.jsxs(de,{color:"secondary",children:[e.jsx(F,{icon:X})," Filters"]}),e.jsx(ce,{children:e.jsxs("div",{className:"p-2",children:[e.jsxs("div",{className:"mb-2",onClick:t=>t.stopPropagation(),onMouseDown:t=>t.stopPropagation(),children:[e.jsx(b,{children:"Period"}),e.jsxs(w,{value:i,onChange:t=>{t.stopPropagation(),R(t.target.value)},disabled:g,onClick:t=>t.stopPropagation(),children:[e.jsx("option",{value:"all",children:"All Periods"}),e.jsx("option",{value:"1",children:"First Half"}),e.jsx("option",{value:"2",children:"2nd Half"})]})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx(b,{children:"Month"}),e.jsx(w,{value:f,onChange:t=>E(parseInt(t.target.value)),disabled:g,children:Array.from({length:12},(t,r)=>e.jsx("option",{value:r+1,children:new Date(2023,r).toLocaleString("default",{month:"long"})},r+1))})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx(b,{children:"Year"}),e.jsx(w,{value:j,onChange:t=>B(parseInt(t.target.value)),disabled:g,children:U.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx(b,{children:"Department"}),e.jsxs(w,{value:h,onChange:t=>k(t.target.value),disabled:g,children:[e.jsx("option",{value:"all",children:"All Departments"}),M.map((t,r)=>e.jsx("option",{value:t,children:t},r))]})]})]})})]}),e.jsx(Z,{color:"primary",onClick:G,disabled:L||g||m.length===0,children:L?e.jsx(_,{size:"sm"}):e.jsx(F,{icon:ee})})]})]}),e.jsxs(ae,{children:[y&&e.jsx(he,{color:"danger",dismissible:!0,onClose:()=>C(null),children:y}),g?e.jsxs("div",{className:"text-center py-4",children:[e.jsx(_,{}),e.jsx("p",{children:"Loading payroll data..."})]}):e.jsx("div",{className:"table-responsive",children:e.jsxs(xe,{hover:!0,bordered:!0,responsive:!0,children:[e.jsx(me,{children:e.jsxs(u,{children:[e.jsx(o,{children:"Employee ID"}),e.jsx(o,{children:"Name"}),e.jsx(o,{children:"Department"}),e.jsx(o,{children:"Base Salary"}),e.jsx(o,{children:"Overtime"}),e.jsx(o,{children:"Bonus"}),e.jsx(o,{children:"Benefits"}),e.jsx(o,{children:"Deductions"}),e.jsx(o,{children:"Net Salary"}),e.jsx(o,{children:"Status"}),e.jsx(o,{children:"Pay Period"})]})}),e.jsx(pe,{children:m.length>0?Object.entries(T(m)).map(([t,r],s)=>e.jsxs(Q.Fragment,{children:[e.jsx(u,{children:e.jsxs(n,{colSpan:"11",style:q,children:[t," -"," ",z(r[0].start_date,r[0].end_date)]})}),r.map((a,d)=>e.jsxs(u,{children:[e.jsx(n,{children:a.employee_id||"N/A"}),e.jsx(n,{children:a.name||"N/A"}),e.jsx(n,{children:a.department||"N/A"}),e.jsx(n,{children:x(a.base_salary)}),e.jsx(n,{children:x(a.total_overtime_amount)}),e.jsx(n,{children:x(a.bonus)}),e.jsx(n,{children:x(a.benefits_total)}),e.jsx(n,{children:x(a.total_deductions||a.tax)}),e.jsx(n,{children:x(a.net_salary)}),e.jsx(n,{children:e.jsx(ie,{color:W(a.status),children:a.status||"Pending"})}),e.jsx(n,{children:a.period===1?"1st Half":"2nd Half"})]},`${a.id}-${d}`)),e.jsxs(u,{style:J,children:[e.jsx(n,{colSpan:"8",className:"text-center",children:e.jsx("strong",{children:"Department Total"})}),e.jsx(n,{className:"text-center",children:e.jsx("strong",{children:x(r.reduce((a,d)=>a+parseFloat(d.net_salary||0),0))})}),e.jsx(n,{colSpan:"2"})]}),s<Object.keys(T(m)).length-1&&e.jsx(u,{children:e.jsx(n,{colSpan:"11",style:{padding:"10px"},children:e.jsx("hr",{style:{borderTop:"1px solid #ddd"}})})})]},t)):e.jsx(u,{children:e.jsx(n,{colSpan:"11",className:"text-center py-4",children:y?"Error loading data":"No payroll data available for selected filters"})})}),m.length>0&&e.jsx(ue,{children:e.jsxs(u,{style:{backgroundColor:"#dee2e6"},children:[e.jsx(o,{colSpan:"8",className:"text-center",children:e.jsx("strong",{children:"Grand Total"})}),e.jsx(o,{className:"text-center",children:e.jsx("strong",{children:x(O())})}),e.jsx(o,{colSpan:"2"})]})})]})})]})]})})};export{$e as default};
